name: Deploy to Staging

on:
  push:
    branches: [ main ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Fly CLI
      run: |
        curl -L https://fly.io/install.sh | sh
        export FLYCTL_INSTALL="/home/runner/.fly"
        export PATH="$FLYCTL_INSTALL/bin:$PATH"
        echo "$FLYCTL_INSTALL/bin" >> $GITHUB_PATH
        echo "FLY_API_TOKEN=${{ secrets.FLY_API_TOKEN }}" >> $GITHUB_ENV

    - name: Check Fly CLI authentication
      run: fly auth whoami

    - name: Clean up any existing staging resources
      run: |
        echo "Cleaning up any existing staging resources..."
        
        # Stop any running machines first
        echo "Stopping any running machines..."
        fly machines list --app just-ingredients-staging --json | jq -r '.[].id' | while read machine_id; do
          echo "Stopping machine $machine_id..."
          fly machines stop $machine_id --app just-ingredients-staging || true
        done || true
        
        # Wait a bit for machines to stop
        echo "Waiting for machines to stop..."
        sleep 10
        
        # Destroy apps
        fly apps destroy just-ingredients-staging --yes || true
        fly apps destroy just-ingredients-staging-db --yes || true
        
        # Additional cleanup for any orphaned resources
        echo "Checking for any remaining resources..."
        fly machines list --app just-ingredients-staging 2>/dev/null || echo "No machines found"
        
        echo "Cleanup completed"

    - name: Create staging app
      uses: superfly/flyctl-actions@master
      with:
        args: apps create just-ingredients-staging --org personal --yes
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: Verify staging app creation
      run: |
        echo "Verifying staging app was created successfully..."
        if ! fly apps list | grep -q "just-ingredients-staging"; then
          echo "Staging app creation failed - just-ingredients-staging not found in apps list"
          exit 1
        fi
        echo "Staging app creation verified successfully"

    - name: Create staging database
      uses: superfly/flyctl-actions@master
      with:
        args: postgres create --name just-ingredients-staging-db --region cdg --org personal --vm-size shared-cpu-1x --volume-size 1 --password staging_password_123 --initial-cluster-size 1
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      continue-on-error: true

    - name: Attach database to staging app
      uses: superfly/flyctl-actions@master
      with:
        args: postgres attach just-ingredients-staging-db --app just-ingredients-staging --yes
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      continue-on-error: true

    - name: Set staging secrets
      uses: superfly/flyctl-actions@master
      with:
        args: secrets set TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} --app just-ingredients-staging
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: Deploy to staging
      id: deploy
      uses: superfly/flyctl-actions@master
      with:
        args: deploy --config deploy/fly-staging.toml --remote-only --app just-ingredients-staging
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: Retry deployment on failure
      if: steps.deploy.outcome == 'failure'
      uses: superfly/flyctl-actions@master
      with:
        args: deploy --config deploy/fly-staging.toml --remote-only --app just-ingredients-staging
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      continue-on-error: true

    - name: Verify database creation
      run: |
        echo "Verifying database was created successfully..."
        if ! fly apps list | grep -q "just-ingredients-staging-db"; then
          echo "Database creation failed - just-ingredients-staging-db not found in apps list"
          exit 1
        fi
        echo "Database creation verified successfully"

  smoke-tests:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run smoke tests
      run: npm run smoke-test
      env:
        STAGING_URL: https://just-ingredients-staging.fly.dev

  cleanup-staging:
    needs: smoke-tests
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Setup Fly CLI
      run: |
        curl -L https://fly.io/install.sh | sh
        export FLYCTL_INSTALL="/home/runner/.fly"
        export PATH="$FLYCTL_INSTALL/bin:$PATH"
        echo "$FLYCTL_INSTALL/bin" >> $GITHUB_PATH
        echo "FLY_API_TOKEN=${{ secrets.FLY_API_TOKEN }}" >> $GITHUB_ENV

    - name: Clean up staging resources
      run: |
        echo "Cleaning up staging resources..."
        fly apps destroy just-ingredients-staging --yes || true
        fly apps destroy just-ingredients-staging-db --yes || true
        echo "Cleanup completed"