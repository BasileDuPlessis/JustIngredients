name: Deploy to Staging

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed

jobs:
  deploy-staging:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Deploy to staging
      run: fly deploy --config fly-staging.toml --app just-ingredients-staging
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: Run database migrations
      run: fly ssh console --app just-ingredients-staging --command "cargo run --bin migrate"
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}