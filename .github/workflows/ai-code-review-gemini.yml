name: AI Code Review (Google Gemini)

on:
  push:
    branches: [ main ]

jobs:
  gemini-code-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      run: |
        # Compare with previous commit on push
        BASE_SHA="${{ github.event.before }}"
        HEAD_SHA="${{ github.event.after }}"

        CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | head -20)
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        RUST_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(rs|toml)$' || true)
        echo "has_rust_changes=$([ -n "$RUST_FILES" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

    - name: Generate diff analysis
      id: diff-analysis
      if: steps.changed-files.outputs.has_rust_changes == 'true'
      run: |
        # Compare with previous commit on push
        BASE_SHA="${{ github.event.before }}"
        HEAD_SHA="${{ github.event.after }}"

        DIFF=$(git diff $BASE_SHA $HEAD_SHA --no-color --no-ext-diff | head -500)

        LINES_ADDED=$(echo "$DIFF" | grep '^+' | grep -v '^+++' | wc -l)
        LINES_DELETED=$(echo "$DIFF" | grep '^-' | grep -v '^---' | wc -l)
        FILES_CHANGED=$(echo "$DIFF" | grep '^diff --git' | wc -l)

        echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
        echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
        echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

        echo "diff<<EOF" >> $GITHUB_OUTPUT
        echo "$DIFF" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: AI Code Review with Google Gemini
      id: ai-review
      if: env.GOOGLE_AI_API_KEY != ''
      env:
        GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
      run: |
        if [ -z "$GOOGLE_AI_API_KEY" ]; then
          echo "No Google AI API key provided - skipping AI analysis"
          echo "priority=NONE" >> $GITHUB_OUTPUT
          echo "issues=NO_API_KEY" >> $GITHUB_OUTPUT
          echo "recommendations=" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Create the analysis prompt for Gemini
        # Store diff content in a temporary file to avoid shell interpretation issues
        echo "${{ steps.diff-analysis.outputs.diff }}" > diff_content.txt
        DIFF_CONTENT=$(cat diff_content.txt)
        if [ -z "$DIFF_CONTENT" ]; then
          DIFF_CONTENT="No Rust code changes in this commit."
        fi

        cat > analysis_request.json << EOF
        {
          "contents": [
            {
              "parts": [
                {
                  "text": "You are an expert Rust code reviewer. Analyze this code diff and identify ONLY critical issues that could cause security vulnerabilities, data loss, performance problems, or safety issues. Focus on Rust-specific concerns like unsafe code, lifetime issues, and concurrency problems.\n\nCRITICAL ISSUES TO FLAG:\n1. Security: SQL injection, unsafe Rust usage, authentication bypasses\n2. Safety: Race conditions, memory unsafety, improper error handling\n3. Performance: Memory leaks, quadratic algorithms, unbounded resource usage\n4. Data integrity: Missing transactions, improper validation\n\nIGNORE: Style issues, documentation, minor optimizations, test coverage.\n\nIf no critical issues found, respond with: NO_CRITICAL_ISSUES\n\nOtherwise respond in JSON format:\n{\"priority\": \"HIGH|MEDIUM|LOW|NONE\", \"issues\": [\"issue1\", \"issue2\"], \"recommendations\": [\"rec1\", \"rec2\"]}\n\nCode diff:\n$DIFF_CONTENT"
                }
              ]
            }
          ],
          "generationConfig": {
            "temperature": 0.1,
            "maxOutputTokens": 1500
          }
        }
        EOF

        # Call Google Gemini API
        RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GOOGLE_AI_API_KEY" \
          -H "Content-Type: application/json" \
          -d @analysis_request.json)

        # Extract the response
        if echo "$RESPONSE" | jq -e '.candidates[0].content.parts[0].text' >/dev/null 2>&1; then
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          # Parse JSON response (Gemini returns text that should be JSON)
          PRIORITY=$(echo "$ANALYSIS" | jq -r '.priority // "NONE"' 2>/dev/null || echo "NONE")
          ISSUES=$(echo "$ANALYSIS" | jq -r '.issues // [] | join("\n")' 2>/dev/null || echo "")
          RECOMMENDATIONS=$(echo "$ANALYSIS" | jq -r '.recommendations // [] | join("\n")' 2>/dev/null || echo "")

          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "recommendations<<EOF" >> $GITHUB_OUTPUT
          echo "$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "API call failed or returned invalid response"
          echo "Response: $RESPONSE"
          echo "priority=NONE" >> $GITHUB_OUTPUT
          echo "issues=API_ERROR" >> $GITHUB_OUTPUT
          echo "recommendations=" >> $GITHUB_OUTPUT
        fi

        # Clean up temporary file
        rm -f diff_content.txt

    - name: Send Telegram Notification
      if: steps.ai-review.outputs.priority != 'NONE' && steps.ai-review.outputs.issues != 'NO_CRITICAL_ISSUES' && steps.ai-review.outputs.issues != 'API_ERROR' && steps.ai-review.outputs.issues != '' && steps.ai-review.outputs.issues != 'NO_API_KEY'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Format the message
        format_list() {
          echo "$1" | sed 's/^/- /' | sed '/^$/d'
        }

        ISSUES_FORMATTED=$(format_list "${{ steps.ai-review.outputs.issues }}")
        RECOMMENDATIONS_FORMATTED=$(format_list "${{ steps.ai-review.outputs.recommendations }}")

        MESSAGE="ü§ñ *Google Gemini AI Code Review Alert*

        üìã *Push to main branch*
        üë§ *Author:* ${{ github.event.head_commit.author.name }}
        ÔøΩ *Commit:* ${{ github.event.after }}
        ÔøΩ *Message:* ${{ github.event.head_commit.message }}

        üìä *Changes:* ${{ steps.diff-analysis.outputs.files_changed }} files, +${{ steps.diff-analysis.outputs.lines_added }} -${{ steps.diff-analysis.outputs.lines_deleted }} lines

        ‚ö†Ô∏è *Priority:* ${{ steps.ai-review.outputs.priority }}

        üîç *Critical Issues:*
        $ISSUES_FORMATTED

        üí° *Recommendations:*
        $RECOMMENDATIONS_FORMATTED"

        # Send to Telegram
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
          echo "‚úÖ Gemini AI review notification sent"
        else
          echo "‚ö†Ô∏è  Telegram secrets not configured - notification skipped"
          echo "üìù Message preview:"
          echo "$MESSAGE"
        fi